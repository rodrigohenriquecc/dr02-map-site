<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CGR 02 ‚Äì Sistema de Localiza√ß√£o (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- === bibliotecas auxiliares (mantidas) === -->
  <link rel="icon" href="data:," />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.2/dist/shp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ========================================================= -->
  <!-- GOOGLE MAPS ‚Äì a fun√ß√£o initMap precisa existir antes da API -->
  <!-- ========================================================= -->
  <script>
    /*-------------------- Google Maps bootstrap --------------------*/
    function initMap () {
      console.log('üöÄ initMap chamada pela API do Google Maps');
      try {
        const mapa = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: { lat: -23.8, lng: -48.5 },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          gestureHandling: 'greedy',
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: false,
          fullscreenControl: true
        });
        console.log('‚úÖ Google Maps inicializado!');

        /* carrega o restante do sistema (script_google_maps.js) */
        if (typeof carregarSistemaCompleto === 'function') {
          carregarSistemaCompleto(mapa);
        } else {
          const s = document.createElement('script');
          s.src = 'archives/assets/js/script_google_maps.js';
          s.onload = () => {
            console.log('üìÅ script_google_maps.js carregado');
            carregarSistemaCompleto(mapa);
          };
          document.head.appendChild(s);
        }
        window.mapa = mapa;      // debug
      } catch (e) {
        console.error('‚ùå Erro ao inicializar mapa:', e);
      }
    }
    window.initMap = initMap;     // exp√µe global
    console.log('‚úÖ initMap definida globalmente');
  </script>

  <!-- carrega a API do Google Maps se ainda n√£o estiver presente -->
  <script>
    const CHAVE_GOOGLE_MAPS = 'AIzaSyDktuBso1pmwaQNwKsqvb54aslwRurHB5c';
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
      const s = document.createElement('script');
      s.src =
        `https://maps.googleapis.com/maps/api/js?key=${CHAVE_GOOGLE_MAPS}` +
        `&libraries=geometry,visualization,places,drawing` +
        `&callback=initMap&v=weekly&loading=async`;
      s.defer = s.async = true;
      document.head.appendChild(s);
    }
  </script>

  <!-- ===================== SEU C√ìDIGO PRINCIPAL ===================== -->
  <script>
    /*--------------------------------------------------------------*/
    /*  Constantes globais                                          */
    /*--------------------------------------------------------------*/
    const PLANILHA_PONTOS_INTERESSE_URL =
      'https://der59.ultra.com.vc/s/XnHbszyHyRMQrgP/download?path=&files=pontos_de_interesse.xlsx';

    const URLS_ALTERNATIVAS_ONEDRIVE = [
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd',
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd/download',
      'https://1drv.ms/x/c/3417733bdfe00f49/EZultx4njYtFpeZwfiQg12oBeULjNBQDXhzKLHpBxyLsjQ?download=1'
    ];

    const PLANILHA_LINHAS_TRECHO_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2wW76oOiHiip6-ThZWsw6hH5_y-7klCFeKUtR5J7VfSPEfN0G721SFxqLz9twIW25_JhYMXHsH69Z/pub?output=csv';

    /*--------------------------------------------------------------*/
    /*  Vari√°veis de estado                                         */
    /*--------------------------------------------------------------*/
    let dadosOriginais      = [];
    let dadosFiltro         = [];
    let marcadoresFiltro    = [];
    let marcadoresPI        = [];
    let linhasPorTrecho     = [];
    let pontosInteresseAtivos = false;
    let linhasTrechoAtivas    = false;

    /*--------------------------------------------------------------*/
    /*  Utilidades: notifica√ß√£o simples                             */
    /*--------------------------------------------------------------*/
    function notify (msg, tipo = 'info') {
      const n = Object.assign(document.createElement('div'), {
        textContent: msg
      });
      n.style.cssText = `
        position:fixed;top:20px;right:20px;z-index:5000;
        background:${tipo==='error'?'#f44336':tipo==='success'?'#4caf50':'#2196f3'};
        color:#fff;padding:12px 18px;border-radius:8px;
        font:14px/1.4 "Arial",sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.3)
      `;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 4500);
    }

    /*--------------------------------------------------------------*/
    /*  Fetch com v√°rios m√©todos (lida com CORS)                    */
    /*--------------------------------------------------------------*/
    async function baixarArquivoUltraCloud () {
      const metodosDownload = [
        /* 1) direto */
        () => fetch(PLANILHA_PONTOS_INTERESSE_URL),

        /* 2) via corsproxy.io */
        () => fetch(`https://corsproxy.io/?${encodeURIComponent(PLANILHA_PONTOS_INTERESSE_URL)}`),

        /* 3) URLs alternativas */
        ...URLS_ALTERNATIVAS_ONEDRIVE.map(
          url => () => fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`)
        ),

        /* 4) allorigins (fallback) */
        () => fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(PLANILHA_PONTOS_INTERESSE_URL)}`)
              .then(r => r.ok ? r.json().then(j => ({ ok:true, arrayBuffer:() => fetch('data:,'+j.contents).then(r=>r.arrayBuffer()) })) : Promise.reject())
      ];

      let tentativa = 0;
      for (const metodo of metodosDownload) {
        tentativa++;
        try {
          console.log(`üîÑ tentativa ${tentativa}/${metodosDownload.length}`);
          const resp = await metodo();
          if (!resp.ok) throw new Error(`status ${resp.status}`);
          return resp.arrayBuffer ? resp.arrayBuffer() : resp;   // XLSX via ArrayBuffer
        } catch (e) {
          console.warn(`‚ö†Ô∏è falhou tentativa ${tentativa}:`, e.message);
        }
      }
      throw new Error('Todas as tentativas de download falharam');
    }

    /*--------------------------------------------------------------*/
    /*  Carrega e processa pontos de interesse                      */
    /*--------------------------------------------------------------*/
    async function carregarPontosInteresse () {
      try {
        notify('Carregando pontos de interesse‚Ä¶','info');

        const buffer = await baixarArquivoUltraCloud();             // <-- download
        const wb = XLSX.read(buffer, { type: 'array' });            // SheetJS
        const ws = wb.Sheets[wb.SheetNames[0]];
        const dados = XLSX.utils.sheet_to_json(ws, { header:1 });

        /* transforma para objetos */
        const [cabec, ...linhas] = dados;
        const pontos = linhas.map(l => {
          const obj={}; cabec.forEach((h,i)=>obj[h]=l[i]); return obj;
        }).filter(o=>Object.keys(o).length);
        console.log('‚úÖ planilha carregada:', pontos.length,'registros');

        processarDadosCarregados(pontos);  // sua fun√ß√£o existente
        notify('Pontos de interesse carregados!','success');
      } catch (e) {
        console.error('‚ùå erro ao carregar PI:', e);
        notify('Erro ao conectar com a planilha do Ultra Cloud','error');
      }
    }

    /*--------------------------------------------------------------*/
    /*  DEMO ‚Äì bot√£o para testar                                    */
    /*--------------------------------------------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pontosInteresseBtn')
              .addEventListener('click', carregarPontosInteresse);
    });

    /*--------------------------------------------------------------*/
    /*  (o restante das suas fun√ß√µes originais permanece igual)     */
    /*--------------------------------------------------------------*/
  </script>

  <!-- ============================================================ -->
  <!-- estilos, HTML da interface e demais scripts originais aqui‚Ä¶  -->
  <!-- (n√£o alterados, mantive tudo igual ao seu arquivo anterior)  -->
  <!-- ============================================================ -->

  <style>html,body,#map{height:100%;margin:0;padding:0}</style>
</head>
<body>
  <button id="pontosInteresseBtn"
          style="position:fixed;top:15px;left:15px;z-index:3000">
    Pontos de Interesse
  </button>
  <div id="map"></div>
</body>
</html>
