<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CGR 02 - Sistema de Localiza√ß√£o (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- favicon "vazio" evita 404 -->
  <link rel="icon" href="data:," />

  <!-- JSZip, shp.js, Turf, PapaParse, toGeoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.2/dist/shp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- =================== GOOGLE MAPS =================== -->
  <!-- 1) A fun√ß√£o initMap PRECISA estar dispon√≠vel antes de a API carregar -->
  <script>
    // Fun√ß√£o chamada como callback pela API do Google Maps
    function initMap() {
      console.log('üöÄ initMap chamada pela API do Google Maps');
      try {
        const mapa = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: { lat: -23.8, lng: -48.5 },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          gestureHandling: 'greedy',
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: false,
          fullscreenControl: true,
        });
        console.log('‚úÖ Google Maps inicializado com sucesso!');

        // Carrega o restante do sistema (script_google_maps.js)
        if (typeof carregarSistemaCompleto === 'function') {
          carregarSistemaCompleto(mapa);
        } else {
          console.log('‚ö†Ô∏è Sistema completo n√£o dispon√≠vel, carregando...');
          const script = document.createElement('script');
          script.src = 'archives/assets/js/script_google_maps.js';
          script.onload = () => {
            console.log('‚úÖ Script do sistema carregado');
            if (typeof carregarSistemaCompleto === 'function') {
              carregarSistemaCompleto(mapa);
            }
          };
          document.head.appendChild(script);
        }

        // Exp√µe o objeto do mapa globalmente (√∫til para depura√ß√£o)
        window.mapa = mapa;
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Google Maps:', error);
      }
    }
    // Garante visibilidade global
    window.initMap = initMap;
    console.log('‚úÖ initMap definida globalmente');
  </script>

  <!-- 2) Carrega a API JavaScript do Google Maps din√¢micamente -->
  <script>
    // üîë Chave de API ‚Äî restrinja por dom√≠nio e por API no Google Cloud Console
    const CHAVE_GOOGLE_MAPS = 'AIzaSyDktuBso1pmwaQNwKsqvb54aslwRurHB5c';

    // Se a API ainda n√£o estiver presente, injeta o <script>
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
      const script = document.createElement('script');
      script.src =
        `https://maps.googleapis.com/maps/api/js?key=${CHAVE_GOOGLE_MAPS}` +
        `&libraries=geometry,places,visualization,drawing` +
        `&callback=initMap&v=weekly&loading=async`;
      script.async = true;
      script.defer = true;

      script.onload = () => console.log('‚úÖ Google Maps API carregada');
      script.onerror = () => console.error('‚ùå Falha ao carregar Google Maps API');

      document.head.appendChild(script);
    }
  </script>
  <!-- =========== ESTILOS B√ÅSICOS =========== -->
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    /* (o restante dos seus estilos permanece inalterado) */
  </style>
</head>
<body>
  <!-- Bot√µes de Acesso √†s Planilhas -->
  <div class="planilhas-container">
    <a href="https://docs.google.com/spreadsheets/d/1Zxrq6L68fkTuygCE6yVVLOb9wU0UhoQfQHOMm_Xr8RI/edit?gid=1698628532#gid=1698628532" target="_blank" class="btn-planilha btn-pontos">
      Pontos de Interesse
    </a>
    <a href="https://docs.google.com/spreadsheets/d/1IcM6qrF9JpZlJ6c6P1pvb8O5bhmdgDz4gKCtf8V2JUg/edit?usp=drive_link" target="_blank" class="btn-planilha btn-calor">
      Mapa de Calor
    </a>
    <a href="https://docs.google.com/spreadsheets/d/1r-7wdW8IwNhDMmGJ_QoflML-Mo1wvgAuw6ILK_LFlpo/edit?usp=drive_link" target="_blank" class="btn-planilha">
      Linhas por Trecho
    </a>
  </div>

  <!-- Geolocaliza√ß√£o -->
  <!-- (mantido inalterado) -->

  <!-- Sidebar esquerda -->
  <!-- (mantido inalterado) -->

  <!-- MAPA GOOGLE MAPS -->
  <div id="map"></div>

  <!-- Fun√ß√£o utilit√°ria mostrarMensagemDiscreta -->
  <!-- (mantido inalterado) -->
</body>
</html>
