<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CGR 02 ‚Äì Sistema de Localiza√ß√£o (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- === bibliotecas auxiliares (mantidas) === -->
  <link rel="icon" href="data:," />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.2/dist/shp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ========================================================= -->
  <!-- GOOGLE MAPS ‚Äì a fun√ß√£o initMap precisa existir antes da API -->
  <!-- ========================================================= -->
  <script>
    /*-------------------- Google Maps bootstrap --------------------*/
    function initMap () {
      console.log('üöÄ initMap chamada pela API do Google Maps');
      try {
        const mapa = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: { lat: -23.8, lng: -48.5 },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          gestureHandling: 'greedy',
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: false,
          fullscreenControl: true
        });
        console.log('‚úÖ Google Maps inicializado!');
        window.mapa = mapa;      // disponibilizar globalmente

        /* carrega o restante do sistema (script_google_maps.js) */
        if (typeof carregarSistemaCompleto === 'function') {
          carregarSistemaCompleto(mapa);
        } else {
          const s = document.createElement('script');
          s.src = 'archives/assets/js/script_google_maps.js';
          s.onload = () => {
            console.log('üìÅ script_google_maps.js carregado');
            carregarSistemaCompleto(mapa);
          };
          document.head.appendChild(s);
        }
        window.mapa = mapa;      // debug
      } catch (e) {
        console.error('‚ùå Erro ao inicializar mapa:', e);
      }
    }
    window.initMap = initMap;     // exp√µe global
    console.log('‚úÖ initMap definida globalmente');
  </script>

  <!-- carrega a API do Google Maps se ainda n√£o estiver presente -->
  <script>
    const CHAVE_GOOGLE_MAPS = 'AIzaSyDktuBso1pmwaQNwKsqvb54aslwRurHB5c';
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
      const s = document.createElement('script');
      s.src =
        `https://maps.googleapis.com/maps/api/js?key=${CHAVE_GOOGLE_MAPS}` +
        `&libraries=geometry,visualization,places,drawing` +
        `&callback=initMap&v=weekly&loading=async`;
      s.defer = s.async = true;
      document.head.appendChild(s);
    }
  </script>

  <!-- ===================== SEU C√ìDIGO PRINCIPAL ===================== -->
  <script>
    /*--------------------------------------------------------------*/
    /*  Constantes globais                                          */
    /*--------------------------------------------------------------*/
    const PLANILHA_PONTOS_INTERESSE_URL =
      'https://der59.ultra.com.vc/s/XnHbszyHyRMQrgP/download?path=&files=pontos_de_interesse.xlsx';

    const URLS_ALTERNATIVAS_ONEDRIVE = [
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd',
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd/download',
      'https://1drv.ms/x/c/3417733bdfe00f49/EZultx4njYtFpeZwfiQg12oBeULjNBQDXhzKLHpBxyLsjQ?download=1'
    ];

    const PLANILHA_LINHAS_TRECHO_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2wW76oOiHiip6-ThZWsw6hH5_y-7klCFeKUtR5J7VfSPEfN0G721SFxqLz9twIW25_JhYMXHsH69Z/pub?output=csv';

    /*--------------------------------------------------------------*/
    /*  Vari√°veis de estado                                         */
    /*--------------------------------------------------------------*/
    let dadosOriginais      = [];
    let dadosFiltro         = [];
    let marcadoresFiltro    = [];
    let marcadoresPI        = [];
    let linhasPorTrecho     = [];
    let pontosInteresseAtivos = false;
    let linhasTrechoAtivas    = false;

    /*--------------------------------------------------------------*/
    /*  Utilidades: notifica√ß√£o simples                             */
    /*--------------------------------------------------------------*/
    function notify (msg, tipo = 'info') {
      const n = Object.assign(document.createElement('div'), {
        textContent: msg
      });
      n.style.cssText = `
        position:fixed;top:20px;right:20px;z-index:5000;
        background:${tipo==='error'?'#f44336':tipo==='success'?'#4caf50':'#2196f3'};
        color:#fff;padding:12px 18px;border-radius:8px;
        font:14px/1.4 "Arial",sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.3)
      `;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 4500);
    }

    /*--------------------------------------------------------------*/
    /*  Fetch com v√°rios m√©todos (lida com CORS)                    */
    /*--------------------------------------------------------------*/
    async function baixarArquivoUltraCloud () {
      const metodosDownload = [
        /* 1) direto */
        () => fetch(PLANILHA_PONTOS_INTERESSE_URL),

        /* 2) via corsproxy.io */
        () => fetch(`https://corsproxy.io/?${encodeURIComponent(PLANILHA_PONTOS_INTERESSE_URL)}`),

        /* 3) URLs alternativas */
        ...URLS_ALTERNATIVAS_ONEDRIVE.map(
          url => () => fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`)
        ),

        /* 4) allorigins (fallback) */
        () => fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(PLANILHA_PONTOS_INTERESSE_URL)}`)
              .then(r => r.ok ? r.json().then(j => ({ ok:true, arrayBuffer:() => fetch('data:,'+j.contents).then(r=>r.arrayBuffer()) })) : Promise.reject())
      ];

      let tentativa = 0;
      for (const metodo of metodosDownload) {
        tentativa++;
        try {
          console.log(`üîÑ tentativa ${tentativa}/${metodosDownload.length}`);
          const resp = await metodo();
          if (!resp.ok) throw new Error(`status ${resp.status}`);
          return resp.arrayBuffer ? resp.arrayBuffer() : resp;   // XLSX via ArrayBuffer
        } catch (e) {
          console.warn(`‚ö†Ô∏è falhou tentativa ${tentativa}:`, e.message);
        }
      }
      throw new Error('Todas as tentativas de download falharam');
    }

    /*--------------------------------------------------------------*/
    /*  Carrega e processa pontos de interesse                      */
    /*--------------------------------------------------------------*/
    async function carregarPontosInteresse () {
      try {
        console.log('üîÑ Iniciando carregamento de pontos de interesse...');
        notify('Carregando pontos de interesse‚Ä¶','info');

        const buffer = await baixarArquivoUltraCloud();             // <-- download
        console.log('üìÑ Buffer recebido, tamanho:', buffer.byteLength, 'bytes');
        
        const wb = XLSX.read(buffer, { type: 'array' });            // SheetJS
        console.log('üìä Workbook carregado. Planilhas:', wb.SheetNames);
        
        const ws = wb.Sheets[wb.SheetNames[0]];
        const dados = XLSX.utils.sheet_to_json(ws, { header:1 });
        console.log('üìã Dados brutos extra√≠dos:', dados.length, 'linhas');

        /* transforma para objetos */
        const [cabec, ...linhas] = dados;
        console.log('üìã Cabe√ßalhos:', cabec);
        
        const pontos = linhas.map(l => {
          const obj={}; cabec.forEach((h,i)=>obj[h]=l[i]); return obj;
        }).filter(o=>Object.keys(o).length);
        console.log('‚úÖ planilha carregada:', pontos.length,'registros');
        console.log('üìÑ Primeiro ponto:', pontos[0]);

        criarMarcadoresPontosInteresse(pontos);  // criar marcadores
        notify('Pontos de interesse carregados!','success');
      } catch (e) {
        console.error('‚ùå erro ao carregar PI:', e);
        notify('Erro ao conectar com a planilha do Ultra Cloud','error');
      }
    }

    /*--------------------------------------------------------------*/
    /*  Criar marcadores dos pontos de interesse no mapa            */
    /*--------------------------------------------------------------*/
    function criarMarcadoresPontosInteresse(pontos) {
      if (!window.mapa) {
        console.warn('‚ö†Ô∏è Mapa n√£o est√° dispon√≠vel ainda, tentando novamente...');
        setTimeout(() => criarMarcadoresPontosInteresse(pontos), 1000);
        return;
      }

      // Limpar marcadores anteriores
      marcadoresPI.forEach(marker => marker.setMap(null));
      marcadoresPI = [];

      console.log('üîç Processando pontos:', pontos);
      let pontosValidos = 0;

      pontos.forEach((ponto, index) => {
        console.log(`üîç Processando ponto ${index + 1}:`, ponto);
        
        // Tentar extrair coordenadas de diferentes campos poss√≠veis
        let lat, lng;
        
        // Verificar se h√° coordenadas diretas
        if (ponto.Latitude && ponto.Longitude) {
          lat = parseFloat(ponto.Latitude);
          lng = parseFloat(ponto.Longitude);
        } else if (ponto.latitude && ponto.longitude) {
          lat = parseFloat(ponto.latitude);
          lng = parseFloat(ponto.longitude);
        } else if (ponto.lat && ponto.lng) {
          lat = parseFloat(ponto.lat);
          lng = parseFloat(ponto.lng);
        }
        
        // Se n√£o h√° coordenadas diretas, tentar usar coordenadas em um campo √∫nico
        if ((!lat || !lng) && ponto.coordenadas) {
          const coords = ponto.coordenadas.toString().split(',');
          if (coords.length === 2) {
            lat = parseFloat(coords[0].trim());
            lng = parseFloat(coords[1].trim());
          }
        }
        
        if (isNaN(lat) || isNaN(lng)) {
          console.warn(`‚ö†Ô∏è Coordenadas inv√°lidas para o ponto ${index + 1}:`, ponto);
          return;
        }

        pontosValidos++;
        
        // Configura√ß√µes do ponto
        const tipo = ponto.tipo || ponto.Tipo || ponto.TIPO || `Ponto ${index + 1}`;
        const cor = ponto.cor || ponto.Cor || '#2196F3';
        const raio = parseFloat(ponto.raio || ponto.Raio || 200);
        const opacidade = parseFloat(ponto.opacidade || ponto.Opacidade || 0.7);
        
        console.log(`üìç Criando ponto: ${tipo} em (${lat}, ${lng})`);
        
        // Criar c√≠rculo
        const circle = new google.maps.Circle({
          strokeColor: cor,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: cor,
          fillOpacity: opacidade,
          map: window.mapa,
          center: { lat, lng },
          radius: raio
        });
        
        // Criar marcador
        const marker = new google.maps.Marker({
          position: { lat, lng },
          map: window.mapa,
          title: tipo,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="${cor}" stroke="#fff" stroke-width="2"/>
                <circle cx="12" cy="12" r="4" fill="#fff"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(24, 24),
            anchor: new google.maps.Point(12, 12)
          }
        });
        
        // InfoWindow
        const infoContent = `
          <div style="font-family: Arial, sans-serif; max-width: 300px;">
            <h3 style="margin: 0 0 10px 0; color: ${cor};">${tipo}</h3>
            ${ponto.rodovia ? `<p><strong>Rodovia:</strong> ${ponto.rodovia}</p>` : ''}
            ${ponto.km ? `<p><strong>Km:</strong> ${ponto.km}</p>` : ''}
            ${ponto.obs ? `<p><strong>Observa√ß√µes:</strong> ${ponto.obs}</p>` : ''}
            <p><strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
            <p><strong>Raio:</strong> ${raio}m | <strong>Cor:</strong> ${cor}</p>
          </div>
        `;
        
        const infoWindow = new google.maps.InfoWindow({
          content: infoContent
        });
        
        // Event listeners
        const openInfo = () => infoWindow.open(window.mapa, marker);
        marker.addListener('click', openInfo);
        circle.addListener('click', openInfo);
        
        // Armazenar refer√™ncias
        marcadoresPI.push(marker);
        marcadoresPI.push(circle);
      });
      
      console.log(`‚úÖ ${pontosValidos} pontos de interesse criados no mapa`);
      
      // Ajustar zoom para mostrar todos os pontos
      if (pontosValidos > 0) {
        const bounds = new google.maps.LatLngBounds();
        marcadoresPI.forEach(item => {
          if (item.getPosition) bounds.extend(item.getPosition());
          if (item.getCenter) bounds.extend(item.getCenter());
        });
        window.mapa.fitBounds(bounds);
        
        if (pontosValidos === 1) {
          window.mapa.setZoom(15); // zoom espec√≠fico para um √∫nico ponto
        }
      }
    }

    /*--------------------------------------------------------------*/
    /*  DEMO ‚Äì bot√£o para testar                                    */
    /*--------------------------------------------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pontosInteresseBtn')
              .addEventListener('click', carregarPontosInteresse);
    });

    /*--------------------------------------------------------------*/
    /*  (o restante das suas fun√ß√µes originais permanece igual)     */
    /*--------------------------------------------------------------*/
  </script>

  <!-- ============================================================ -->
  <!-- estilos, HTML da interface e demais scripts originais aqui‚Ä¶  -->
  <!-- (n√£o alterados, mantive tudo igual ao seu arquivo anterior)  -->
  <!-- ============================================================ -->

  <style>html,body,#map{height:100%;margin:0;padding:0}</style>
</head>
<body>
  <button id="pontosInteresseBtn"
          style="position:fixed;top:15px;left:15px;z-index:3000">
    Pontos de Interesse
  </button>
  <div id="map"></div>
</body>
</html>
