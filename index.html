<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CGR 02 ‚Äì Sistema de Localiza√ß√£o (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- === bibliotecas auxiliares (mantidas) === -->
  <link rel="icon" href="data:," />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.2/dist/shp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ========================================================= -->
  <!-- GOOGLE MAPS ‚Äì a fun√ß√£o initMap precisa existir antes da API -->
  <!-- ========================================================= -->
  <script>
    /*-------------------- Google Maps bootstrap --------------------*/
    function initMap () {
      console.log('üöÄ initMap chamada pela API do Google Maps');
      try {
        const mapa = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: { lat: -23.8, lng: -48.5 },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          gestureHandling: 'greedy',
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          rotateControl: false,
          fullscreenControl: true
        });
        console.log('‚úÖ Google Maps inicializado!');
        window.mapa = mapa;      // disponibilizar globalmente

        /* carrega o restante do sistema (script_google_maps.js) */
        if (typeof carregarSistemaCompleto === 'function') {
          carregarSistemaCompleto(mapa);
        } else {
          const s = document.createElement('script');
          s.src = 'archives/assets/js/script_google_maps.js';
          s.onload = () => {
            console.log('üìÅ script_google_maps.js carregado');
            carregarSistemaCompleto(mapa);
          };
          document.head.appendChild(s);
        }
        window.mapa = mapa;      // debug
      } catch (e) {
        console.error('‚ùå Erro ao inicializar mapa:', e);
      }
    }
    window.initMap = initMap;     // exp√µe global
    console.log('‚úÖ initMap definida globalmente');
  </script>

  <!-- carrega a API do Google Maps se ainda n√£o estiver presente -->
  <script>
    const CHAVE_GOOGLE_MAPS = 'AIzaSyDktuBso1pmwaQNwKsqvb54aslwRurHB5c';
    if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
      const s = document.createElement('script');
      s.src =
        `https://maps.googleapis.com/maps/api/js?key=${CHAVE_GOOGLE_MAPS}` +
        `&libraries=geometry,visualization,places,drawing` +
        `&callback=initMap&v=weekly&loading=async`;
      s.defer = s.async = true;
      document.head.appendChild(s);
    }
  </script>

  <!-- ===================== SEU C√ìDIGO PRINCIPAL ===================== -->
  <script>
    /*--------------------------------------------------------------*/
    /*  Constantes globais                                          */
    /*--------------------------------------------------------------*/
    const PLANILHA_PONTOS_INTERESSE_URL =
      'https://der59.ultra.com.vc/s/XnHbszyHyRMQrgP/download?path=&files=pontos_de_interesse.xlsx';

    const URLS_ALTERNATIVAS_ONEDRIVE = [
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd',
      'https://der59.ultra.com.vc/s/6bz643r3fYnGBzd/download',
      'https://1drv.ms/x/c/3417733bdfe00f49/EZultx4njYtFpeZwfiQg12oBeULjNBQDXhzKLHpBxyLsjQ?download=1'
    ];

    const PLANILHA_LINHAS_TRECHO_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR2wW76oOiHiip6-ThZWsw6hH5_y-7klCFeKUtR5J7VfSPEfN0G721SFxqLz9twIW25_JhYMXHsH69Z/pub?output=csv';

    /*--------------------------------------------------------------*/
    /*  Vari√°veis de estado                                         */
    /*--------------------------------------------------------------*/
    let dadosOriginais      = [];
    let dadosFiltro         = [];
    let marcadoresFiltro    = [];
    let marcadoresPI        = [];
    let linhasPorTrecho     = [];
    let pontosInteresseAtivos = false;
    let linhasTrechoAtivas    = false;

    /*--------------------------------------------------------------*/
    /*  Utilidades: notifica√ß√£o simples                             */
    /*--------------------------------------------------------------*/
    function notify (msg, tipo = 'info') {
      const n = Object.assign(document.createElement('div'), {
        textContent: msg
      });
      n.style.cssText = `
        position:fixed;top:20px;right:20px;z-index:5000;
        background:${tipo==='error'?'#f44336':tipo==='success'?'#4caf50':'#2196f3'};
        color:#fff;padding:12px 18px;border-radius:8px;
        font:14px/1.4 "Arial",sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.3)
      `;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 4500);
    }

    /*--------------------------------------------------------------*/
    /*  Fetch com v√°rios m√©todos (lida com CORS)                    */
    /*--------------------------------------------------------------*/
    async function baixarArquivoUltraCloud () {
      // Sempre usar proxy corsproxy.io para evitar erro de CORS
      try {
        console.log('üîÑ Download via corsproxy.io');
        const resp = await fetch(`https://corsproxy.io/?${encodeURIComponent(PLANILHA_PONTOS_INTERESSE_URL)}`);
        if (!resp.ok) throw new Error(`status ${resp.status}`);
        return resp.arrayBuffer ? resp.arrayBuffer() : resp;
      } catch (e) {
        console.error('‚ùå Falha no download via proxy:', e);
        throw new Error('Download falhou via proxy CORS');
      }
    }

    /*--------------------------------------------------------------*/
    /*  Carrega e processa pontos de interesse                      */
    /*--------------------------------------------------------------*/
    async function carregarPontosInteresse () {
      try {
        console.log('üîÑ Iniciando carregamento de pontos de interesse...');
        notify('Carregando pontos de interesse‚Ä¶','info');

        const buffer = await baixarArquivoUltraCloud();             // <-- download
        console.log('üìÑ Buffer recebido, tamanho:', buffer.byteLength, 'bytes');
        
        const wb = XLSX.read(buffer, { type: 'array' });            // SheetJS
        console.log('üìä Workbook carregado. Planilhas:', wb.SheetNames);
        
        const ws = wb.Sheets[wb.SheetNames[0]];
        const dados = XLSX.utils.sheet_to_json(ws, { header:1 });
        console.log('üìã Dados brutos extra√≠dos:', dados.length, 'linhas');

        /* transforma para objetos */
        const [cabec, ...linhas] = dados;
        console.log('üìã Cabe√ßalhos:', cabec);
        
        const pontos = linhas.map(l => {
          const obj={}; cabec.forEach((h,i)=>obj[h]=l[i]); return obj;
        }).filter(o=>Object.keys(o).length);
        console.log('‚úÖ planilha carregada:', pontos.length,'registros');
        if (pontos.length > 0) {
          console.log('üìÑ Primeiro ponto:', pontos[0]);
          console.log('üîë Campos dispon√≠veis:', Object.keys(pontos[0]));
        } else {
          console.warn('‚ö†Ô∏è Nenhum ponto encontrado na planilha!');
        }

        criarMarcadoresPontosInteresse(pontos);  // criar marcadores
        notify('Pontos de interesse carregados!','success');
      } catch (e) {
        console.error('‚ùå erro ao carregar PI:', e);
        notify('Erro ao conectar com a planilha do Ultra Cloud','error');
      }
    }

    /*--------------------------------------------------------------*/
    /*  Criar marcadores dos pontos de interesse no mapa            */
    /*--------------------------------------------------------------*/
    function criarMarcadoresPontosInteresse(pontos) {
      if (!window.mapa) {
        console.warn('‚ö†Ô∏è Mapa n√£o est√° dispon√≠vel ainda, tentando novamente...');
        setTimeout(() => criarMarcadoresPontosInteresse(pontos), 1000);
        return;
      }

      // Limpar marcadores anteriores
      marcadoresPI.forEach(marker => marker.setMap(null));
      marcadoresPI = [];

      console.log('üîç Processando pontos:', pontos);
      let pontosValidos = 0;

      pontos.forEach((ponto, index) => {
        console.log(`üîç Processando ponto ${index + 1}:`, ponto);
        
        // Tentar extrair coordenadas de diferentes campos poss√≠veis
        let lat, lng;
        
        // PRIORIDADE 1: Usar a nova coluna "Lat e Long" (coordenadas na mesma c√©lula)
        if (ponto['Lat e Long']) {
          const coordText = ponto['Lat e Long'].toString().trim();
          console.log(`[REGEX_PARSE] üîç Analisando c√©lula "Lat e Long": "${coordText}"`);
          
          // Regex para extrair os dois primeiros n√∫meros (negativos, decimais com ponto ou v√≠rgula)
          const numeros = coordText.match(/-?\d+([.,]\d+)?/g);
          console.log(`[REGEX_PARSE] üîç N√∫meros extra√≠dos:`, numeros);

          if (numeros && numeros.length >= 2) {
            // Limpa e converte os n√∫meros para o formato com ponto decimal
            const val1 = parseFloat(numeros[0].replace(',', '.'));
            const val2 = parseFloat(numeros[1].replace(',', '.'));
            
            console.log(`[REGEX_PARSE] üîç Valores num√©ricos convertidos: val1=${val1}, val2=${val2}`);
            
            if (!isNaN(val1) && !isNaN(val2)) {
              // L√≥gica de detec√ß√£o de Lat/Lng (Brasil)
              if (val1 >= -35 && val1 <= -5 && val2 >= -75 && val2 <= -35) {
                lat = val1;
                lng = val2;
                console.log(`[REGEX_PARSE] ‚úÖ Ordem detectada: Lat primeiro (${lat}), Lng segundo (${lng})`);
              } else if (val2 >= -35 && val2 <= -5 && val1 >= -75 && val1 <= -35) {
                lat = val2;
                lng = val1;
                console.log(`[REGEX_PARSE] ‚úÖ Ordem detectada: Lng primeiro (${val1}), Lat segundo (${lat}) - INVERTIDO`);
              } else {
                lat = val1;
                lng = val2;
                console.log(`[REGEX_PARSE] ‚ö†Ô∏è Ordem n√£o detectada, assumindo Lat primeiro: ${lat}, ${lng}`);
              }
              console.log(`[REGEX_PARSE] üìç Coordenadas finais extra√≠das: Lat=${lat}, Long=${lng}`);
            }
          }
        }
        
        // PRIORIDADE 2: Verificar varia√ß√µes do nome da coluna
        if ((!lat || !lng || isNaN(lat) || isNaN(lng))) {
          const possiveisCampos = ['Lat e Long', 'Latitude e Longitude', 'Coordenadas', 'Lat Long', 'LatLong', 'coordenadas'];
          
          for (const campo of possiveisCampos) {
            if (ponto[campo]) {
              const coordText = ponto[campo].toString().trim();
              console.log(`üîç Tentando campo "${campo}": ${coordText}`);
              
              let coords = [];
              if (coordText.includes(',')) {
                coords = coordText.split(',');
              } else if (coordText.includes(';')) {
                coords = coordText.split(';');
              } else if (coordText.includes(' ') && coordText.split(' ').length >= 2) {
                coords = coordText.split(' ').filter(c => c.trim().length > 0);
              }
              
              if (coords.length >= 2) {
                lat = parseFloat(coords[0].trim().replace(',', '.'));
                lng = parseFloat(coords[1].trim().replace(',', '.'));
                console.log(`üìç Coordenadas encontradas em "${campo}": Lat=${lat}, Long=${lng}`);
                break;
              }
            }
          }
        }
        
        // PRIORIDADE 3: Verificar se h√° coordenadas em campos separados (compatibilidade)
        if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.Lat && ponto.Long) {
          lat = parseFloat(ponto.Lat.toString().replace(',', '.'));
          lng = parseFloat(ponto.Long.toString().replace(',', '.'));
          console.log(`üìç Coordenadas em campos separados: Lat=${lat}, Long=${lng}`);
        } else if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.Latitude && ponto.Longitude) {
          lat = parseFloat(ponto.Latitude.toString().replace(',', '.'));
          lng = parseFloat(ponto.Longitude.toString().replace(',', '.'));
        } else if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.latitude && ponto.longitude) {
          lat = parseFloat(ponto.latitude.toString().replace(',', '.'));
          lng = parseFloat(ponto.longitude.toString().replace(',', '.'));
        } else if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.lat && ponto.lng) {
          lat = parseFloat(ponto.lat.toString().replace(',', '.'));
          lng = parseFloat(ponto.lng.toString().replace(',', '.'));
        }
        
        // PRIORIDADE 4: Se ainda n√£o temos coordenadas, buscar por Rodovia e Km
        if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.Rodovia && ponto.Km) {
          const coordsRodovia = buscarCoordenadasPorRodoviaKm(ponto.Rodovia, ponto.Km);
          if (coordsRodovia) {
            lat = coordsRodovia.lat;
            lng = coordsRodovia.lng;
            console.log(`üó∫Ô∏è Coordenadas encontradas por rodovia/km: ${lat}, ${lng} para ${ponto.Rodovia} km ${ponto.Km}`);
          } else {
            console.warn(`‚ö†Ô∏è Coordenadas n√£o encontradas para ${ponto.Rodovia} km ${ponto.Km}`);
          }
        }
        
        // FALLBACK: Tentar campos antigos de rodovia se os novos n√£o existirem
        if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && ponto.rodovia && ponto.km) {
          const coordsRodovia = buscarCoordenadasPorRodoviaKm(ponto.rodovia, ponto.km);
          if (coordsRodovia) {
            lat = coordsRodovia.lat;
            lng = coordsRodovia.lng;
            console.log(`üó∫Ô∏è Coordenadas encontradas por rodovia/km (campos antigos): ${lat}, ${lng} para ${ponto.rodovia} km ${ponto.km}`);
          }
        }
        
        if (isNaN(lat) || isNaN(lng)) {
          console.warn(`‚ö†Ô∏è Coordenadas inv√°lidas para o ponto ${index + 1}:`, ponto);
          return;
        }

        // Verifica√ß√£o de coordenadas do Brasil
        if (lat > -5 || lat < -35 || lng > -35 || lng < -75) {
          console.warn(`‚ö†Ô∏è Coordenadas fora do Brasil detectadas para ponto ${index + 1}: Lat=${lat}, Lng=${lng}`);
          console.warn(`   Faixa esperada: Lat[-35 a -5], Lng[-75 a -35]`);
          console.warn(`   Dados do ponto:`, ponto);
          
          // Tentar inverter se parece que est√° trocado
          if (lng >= -35 && lng <= -5 && lat >= -75 && lat <= -35) {
            console.log(`üîÑ Tentando inverter coordenadas: ${lat} ‚Üî ${lng}`);
            [lat, lng] = [lng, lat];
            console.log(`‚úÖ Coordenadas invertidas: Lat=${lat}, Lng=${lng}`);
          }
        }

        console.log(`üéØ Coordenadas finais validadas: Lat=${lat}, Lng=${lng}`);

        pontosValidos++;
        
        // Configura√ß√µes do ponto usando as novas colunas
        const tipo = ponto.Tipo || ponto.tipo || ponto.TIPO || `Ponto ${index + 1}`;
        const cor = ponto.Cor || ponto.cor || '#2196F3';
        const raio = parseFloat((ponto.Raio || ponto.raio || 200).toString().replace(',', '.'));
        const opacidade = parseFloat((ponto.Opacidade || ponto.opacidade || 0.7).toString().replace(',', '.'));
        const observacoes = ponto.Obs || ponto.obs || ponto.observacoes || '';
        const periodo = ponto.Per√≠odo || ponto.periodo || '';
        
        console.log(`üìç Criando ponto: ${tipo} em (${lat}, ${lng})`);
        
        // Criar c√≠rculo
        const circle = new google.maps.Circle({
          strokeColor: cor,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: cor,
          fillOpacity: opacidade,
          map: window.mapa,
          center: { lat, lng },
          radius: raio
        });
        
        // Criar marcador
        const marker = new google.maps.Marker({
          position: { lat, lng },
          map: window.mapa,
          title: tipo,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="${cor}" stroke="#fff" stroke-width="2"/>
                <circle cx="12" cy="12" r="4" fill="#fff"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(24, 24),
            anchor: new google.maps.Point(12, 12)
          }
        });
        
        // InfoWindow com as novas informa√ß√µes
        const infoContent = `
          <div style="font-family: Arial, sans-serif; max-width: 300px;">
            <h3 style="margin: 0 0 10px 0; color: ${cor};">${tipo}</h3>
            ${ponto.Rodovia ? `<p><strong>Rodovia:</strong> ${ponto.Rodovia}</p>` : ''}
            ${ponto.Km ? `<p><strong>Km:</strong> ${ponto.Km}</p>` : ''}
            ${observacoes ? `<p><strong>Observa√ß√µes:</strong> ${observacoes}</p>` : ''}
            ${periodo ? `<p><strong>Per√≠odo:</strong> ${periodo}</p>` : ''}
            <p><strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
            <p><strong>Raio:</strong> ${raio}m | <strong>Opacidade:</strong> ${opacidade}</p>
            <p><strong>Cor:</strong> ${cor}</p>
          </div>
        `;
        
        const infoWindow = new google.maps.InfoWindow({
          content: infoContent
        });
        
        // Event listeners
        const openInfo = () => infoWindow.open(window.mapa, marker);
        marker.addListener('click', openInfo);
        circle.addListener('click', openInfo);
        
        // Armazenar refer√™ncias
        marcadoresPI.push(marker);
        marcadoresPI.push(circle);
      });
      
      console.log(`‚úÖ ${pontosValidos} pontos de interesse criados no mapa`);
      
      // Ajustar zoom para mostrar todos os pontos
      if (pontosValidos > 0) {
        const bounds = new google.maps.LatLngBounds();
        marcadoresPI.forEach(item => {
          if (item.getPosition) bounds.extend(item.getPosition());
          if (item.getCenter) bounds.extend(item.getCenter());
        });
        window.mapa.fitBounds(bounds);
        
        if (pontosValidos === 1) {
          window.mapa.setZoom(15); // zoom espec√≠fico para um √∫nico ponto
        }
      }
    }

    /*--------------------------------------------------------------*/
    /*  Buscar coordenadas por rodovia e km                         */
    /*--------------------------------------------------------------*/
    function buscarCoordenadasPorRodoviaKm(rodovia, km) {
      // Fun√ß√£o para buscar coordenadas baseadas na rodovia e quilometragem
      // Esta fun√ß√£o tentar√° encontrar um ponto pr√≥ximo nos dados carregados do sistema
      
      console.log(`üîç Buscando coordenadas para ${rodovia} km ${km}`);
      
      // Verificar se temos dados originais carregados (do sistema principal)
      if (!dadosOriginais || dadosOriginais.length === 0) {
        console.warn('‚ö†Ô∏è Dados de rodovias n√£o carregados ainda, usando coordenadas aproximadas');
        return obterCoordenadasAproximadas(rodovia, km);
      }
      
      // Normalizar valores para busca - suporte aos formatos SP XXX e SPA XXX/XXX
      let rodoviaLimpa = rodovia.toString().trim().toUpperCase();
      
      // Normalizar formato: remover espa√ßos extras e padronizar
      rodoviaLimpa = rodoviaLimpa.replace(/\s+/g, ' '); // m√∫ltiplos espa√ßos -> um espa√ßo
      
      // Converter v√≠rgula decimal para ponto
      const kmNumerico = parseFloat(km.toString().replace(',', '.'));
      
      console.log(`üîç Buscando "${rodoviaLimpa}" km ${kmNumerico} em ${dadosOriginais.length} registros`);
      
      // Buscar correspond√™ncia exata ou pr√≥xima
      let melhorMatch = null;
      let menorDistancia = Infinity;
      
      dadosOriginais.forEach(item => {
        // Verificar diferentes campos que podem conter a rodovia
        let rodoviaItem = '';
        
        // Tentar v√°rios campos poss√≠veis
        if (item.SP) {
          rodoviaItem = item.SP.toString().trim().toUpperCase();
        } else if (item.RODOVIA) {
          rodoviaItem = item.RODOVIA.toString().trim().toUpperCase();
        } else if (item.rodovia) {
          rodoviaItem = item.rodovia.toString().trim().toUpperCase();
        }
        
        // Normalizar formato da rodovia do item
        rodoviaItem = rodoviaItem.replace(/\s+/g, ' ');
        
        // Verificar diferentes campos que podem conter o km
        let kmItem = 0;
        if (item['KM ']) {
          kmItem = parseFloat(item['KM '].toString().replace(',', '.'));
        } else if (item.KM) {
          kmItem = parseFloat(item.KM.toString().replace(',', '.'));
        } else if (item.km) {
          kmItem = parseFloat(item.km.toString().replace(',', '.'));
        }
        
        // Verificar se h√° correspond√™ncia de rodovia
        const rodoviaMatch = rodoviaItem === rodoviaLimpa || 
                            rodoviaItem.includes(rodoviaLimpa) || 
                            rodoviaLimpa.includes(rodoviaItem);
        
        if (rodoviaMatch && !isNaN(kmItem) && item.LOCALIZA√á√ÉO) {
          const distancia = Math.abs(kmItem - kmNumerico);
          if (distancia < menorDistancia) {
            menorDistancia = distancia;
            melhorMatch = item;
          }
        }
      });
      
      if (melhorMatch && melhorMatch.LOCALIZA√á√ÉO) {
        const coords = melhorMatch.LOCALIZA√á√ÉO.split(',');
        if (coords.length === 2) {
          const lat = parseFloat(coords[0].trim());
          const lng = parseFloat(coords[1].trim());
          
          if (!isNaN(lat) && !isNaN(lng)) {
            console.log(`‚úÖ Coordenadas encontradas: ${lat}, ${lng} (dist√¢ncia: ${menorDistancia.toFixed(3)}km)`);
            return { lat, lng };
          }
        }
      }
      
      console.warn(`‚ö†Ô∏è Coordenadas n√£o encontradas para ${rodovia} km ${km}, usando aproxima√ß√£o`);
      return obterCoordenadasAproximadas(rodovia, km);
    }

    /*--------------------------------------------------------------*/
    /*  Obter coordenadas aproximadas por rodovia                   */
    /*--------------------------------------------------------------*/
    function obterCoordenadasAproximadas(rodovia, km) {
      // Coordenadas aproximadas para principais rodovias de S√£o Paulo
      // Suporte aos formatos SP XXX e SPA XXX/XXX
      const rodoviasCoordenadas = {
        // Formato SP XXX
        'SP 270': { lat: -23.5505, lng: -47.4583 }, // Raposo Tavares
        'SP 280': { lat: -23.5505, lng: -47.0058 }, // Castelo Branco
        'SP 310': { lat: -22.8084, lng: -47.0647 }, // Washington Lu√≠s
        'SP 330': { lat: -22.9068, lng: -47.0631 }, // Anhanguera
        'SP 348': { lat: -23.0329, lng: -47.2319 }, // Bandeirantes
        'SP 160': { lat: -23.8775, lng: -46.3297 }, // Imigrantes
        'SP 150': { lat: -23.7348, lng: -46.5653 }, // Anchieta
        'SP 099': { lat: -23.9297, lng: -46.3031 }, // Tamoios
        'SP 070': { lat: -23.4424, lng: -46.5477 }, // Ayrton Senna
        'SP 021': { lat: -23.5505, lng: -46.6333 }, // Rodoanel (trecho Sul)
        'SP 332': { lat: -22.7358, lng: -47.3369 }, // General Milton Tavares
        'SP 225': { lat: -22.5406, lng: -47.4011 }, // Eng. Jo√£o Tosello
        
        // Formato SPA XXX/XXX (acessos e trevos)
        'SPA 070/330': { lat: -23.3200, lng: -46.7300 }, // Acesso SP-070/SP-330
        'SPA 280/160': { lat: -23.6500, lng: -46.8000 }, // Acesso SP-280/SP-160
        'SPA 348/330': { lat: -23.1200, lng: -46.9500 }, // Acesso SP-348/SP-330
        'SPA 270/160': { lat: -23.7000, lng: -46.9200 }, // Acesso SP-270/SP-160
        'SPA 021/280': { lat: -23.6200, lng: -46.7800 }, // Acesso Rodoanel/Castelo Branco
        'SPA 021/160': { lat: -23.8200, lng: -46.4500 }, // Acesso Rodoanel/Imigrantes
        'SPA 021/150': { lat: -23.7800, lng: -46.5200 }, // Acesso Rodoanel/Anchieta
        
        // Varia√ß√µes sem espa√ßo (compatibilidade)
        'SP270': { lat: -23.5505, lng: -47.4583 },
        'SP280': { lat: -23.5505, lng: -47.0058 },
        'SP310': { lat: -22.8084, lng: -47.0647 },
        'SP330': { lat: -22.9068, lng: -47.0631 },
        'SP348': { lat: -23.0329, lng: -47.2319 },
        'SP160': { lat: -23.8775, lng: -46.3297 },
        'SP150': { lat: -23.7348, lng: -46.5653 },
        'SP099': { lat: -23.9297, lng: -46.3031 },
        'SP070': { lat: -23.4424, lng: -46.5477 },
        'SP021': { lat: -23.5505, lng: -46.6333 }
      };
      
      // Normalizar rodovia para busca
      let rodoviaLimpa = rodovia.toString().trim().toUpperCase();
      rodoviaLimpa = rodoviaLimpa.replace(/\s+/g, ' '); // normalizar espa√ßos
      
      // Converter v√≠rgula decimal para ponto
      const kmNumerico = parseFloat(km.toString().replace(',', '.'));
      
      console.log(`üîç Buscando coordenadas aproximadas para "${rodoviaLimpa}" km ${kmNumerico}`);
      
      // Buscar a rodovia nas coordenadas aproximadas
      let baseCoords = rodoviasCoordenadas[rodoviaLimpa];
      
      // Se n√£o encontrar com espa√ßo, tentar sem espa√ßo
      if (!baseCoords) {
        const rodoviaSemEspaco = rodoviaLimpa.replace(/\s+/g, '');
        baseCoords = rodoviasCoordenadas[rodoviaSemEspaco];
      }
      
      // Se ainda n√£o encontrar, tentar busca parcial
      if (!baseCoords) {
        for (const [key, coords] of Object.entries(rodoviasCoordenadas)) {
          if (key.includes(rodoviaLimpa) || rodoviaLimpa.includes(key)) {
            baseCoords = coords;
            console.log(`üîç Encontrada correspond√™ncia parcial: ${key} para ${rodoviaLimpa}`);
            break;
          }
        }
      }
      
      if (!baseCoords) {
        // Se n√£o encontrar a rodovia espec√≠fica, usar coordenadas centrais de SP
        console.warn(`‚ö†Ô∏è Rodovia "${rodoviaLimpa}" n√£o encontrada, usando coordenadas centrais de SP`);
        baseCoords = { lat: -23.5505, lng: -46.6333 }; // Centro de S√£o Paulo
      }
      
      // Ajustar coordenadas baseado no km (aproxima√ß√£o melhorada)
      // Cada km representa aproximadamente 0.009 graus (mais preciso)
      const fatorKm = 0.009;
      
      // Para SPA (acessos), usar menos varia√ß√£o
      const isSPA = rodoviaLimpa.startsWith('SPA');
      const ajusteKm = isSPA ? kmNumerico * fatorKm * 0.5 : kmNumerico * fatorKm;
      
      // Varia√ß√£o baseada na dire√ß√£o t√≠pica da rodovia
      let latAjuste = 0, lngAjuste = 0;
      
      if (rodoviaLimpa.includes('270')) { // Raposo Tavares (E-O)
        lngAjuste = ajusteKm;
      } else if (rodoviaLimpa.includes('280')) { // Castelo Branco (E-O)
        lngAjuste = ajusteKm;
      } else if (rodoviaLimpa.includes('330') || rodoviaLimpa.includes('348')) { // N-S
        latAjuste = ajusteKm;
      } else if (rodoviaLimpa.includes('160') || rodoviaLimpa.includes('150')) { // N-S
        latAjuste = -ajusteKm; // dire√ß√£o sul
      } else {
        // Dire√ß√£o padr√£o para outras rodovias
        latAjuste = ajusteKm * 0.5;
        lngAjuste = ajusteKm * 0.5;
      }
      
      const lat = baseCoords.lat + latAjuste;
      const lng = baseCoords.lng + lngAjuste;
      
      console.log(`üìç Coordenadas aproximadas calculadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} para ${rodovia} km ${km}`);
      return { lat, lng };
    }

    /*--------------------------------------------------------------*/
    /*  DEMO ‚Äì bot√£o para testar                                    */
    /*--------------------------------------------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pontosInteresseBtn')
              .addEventListener('click', carregarPontosInteresse);
    });

    /*--------------------------------------------------------------*/
    /*  (o restante das suas fun√ß√µes originais permanece igual)     */
    /*--------------------------------------------------------------*/
  </script>

  <!-- ============================================================ -->
  <!-- estilos, HTML da interface e demais scripts originais aqui‚Ä¶  -->
  <!-- (n√£o alterados, mantive tudo igual ao seu arquivo anterior)  -->
  <!-- ============================================================ -->

  <style>html,body,#map{height:100%;margin:0;padding:0}</style>
</head>
<body>
  <button id="pontosInteresseBtn"
          style="position:fixed;top:15px;left:15px;z-index:3000">
    Pontos de Interesse
  </button>
  <div id="map"></div>
</body>
</html>
